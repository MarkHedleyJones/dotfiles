#!/usr/bin/env bash

# Push local aliases to GitHub Gist
# Requires: gh CLI tool and authentication

ALIASES_FILE="${HOME}/.aliases"
GIST_FILE=".aliases"
GIST_DESCRIPTION="Personal shell aliases (private)"

# Check if gh is installed
if ! command -v gh &> /dev/null; then
    echo "Error: GitHub CLI (gh) is not installed"
    echo "Install it with: sudo apt install gh"
    echo "Then authenticate with: gh auth login"
    exit 1
fi

# Check if aliases file exists
if [ ! -f "${ALIASES_FILE}" ]; then
    echo "Error: Aliases file not found at ${ALIASES_FILE}"
    exit 1
fi

# Check if user is authenticated
if ! gh auth status &>/dev/null; then
    echo "Error: Not authenticated with GitHub"
    echo "Run: gh auth login"
    exit 1
fi

# Check if gist already exists
GIST_ID=$(gh gist list --limit 100 | grep "${GIST_DESCRIPTION}" | awk '{print $1}' | head -1)

if [ -z "${GIST_ID}" ]; then
    # Create new gist
    echo "Creating new private gist..."
    gh gist create "${ALIASES_FILE}" --desc "${GIST_DESCRIPTION}" --filename "${GIST_FILE}"
    echo "Gist created successfully!"
    echo "To clone on another machine, run: aliases-pull"
else
    # Update existing gist
    echo "Updating existing gist (${GIST_ID})..."
    gh gist edit "${GIST_ID}" "${ALIASES_FILE}"
    echo "Gist updated successfully!"
fi

# Show the gist URL
echo ""
echo "Your aliases gist:"
gh gist view "${GIST_ID:-$(gh gist list --limit 1 | awk '{print $1}')}" --web